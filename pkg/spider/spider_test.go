// Copyright 2023 The proksi Authors. All rights reserved.
// Use of this source code is governed by a MIT-style
// license that can be found in the LICENSE file.

package spider

import (
	"bytes"
	"fmt"
	"os"
	"testing"
	"time"

	"github.com/antchfx/htmlquery"
	"gopkg.in/yaml.v3"
)

func TestRenderSpiders(t *testing.T) {
	b, _ := os.ReadFile("/Users/Leosocy/workspace/repos/myself/proksi/config/config.yaml")
	config := make(map[string]interface{})
	yaml.Unmarshal(b, &config)
	spiders, _ := RenderSpiders("/Users/Leosocy/workspace/repos/myself/proksi/config/spiders.tpl.yaml", Values(config["spiders"].(map[string]interface{})))
	for _, spider := range spiders {
		spider.Start()
	}
	time.Sleep(time.Minute)
}

func TestXpathSubstringBefore(t *testing.T) {
	b := []byte("<a href=\"https://proxy.ip3366.net/\" target=\"_blank\" data-type=\"img\"><img src=\"img/hfad.png\"></a><br><script type=\"text/javascript\" src=\"js/jquery.min.js\"></script>\n<div id=\"adarea\"onclick=location.href='https://proxy.ip3366.net/' style=\"cursor: pointer;display: none;position: fixed;right:15px;bottom:15px;width: 285px;height: 250px;background: url(/img/fkad.png) no-repeat;\">\n<div id=\"adclose\" style=\"cursor: pointer; position: absolute;  top: 0px;  left: 0px;  display: block;  width: 20px;  height: 20px;font-family: cursive;background: url(img/close.png) no-repeat;\" title=\"点击关闭\"> </div>\n</div>\n<script type=\"text/javascript\">\n$(function(){\n$('#adarea').slideDown(500);\n$('#adclose').click(function(){\n$('#adarea').slideUp(500);\n});\n});\n</script>\n170.64.150.114:80<br>49.86.178.131:8089<br>36.6.145.192:8089<br>61.190.160.188:8089<br>222.190.208.77:8089<br>174.139.41.164:9090<br>27.150.85.146:8089<br>36.6.159.79:8089<br>42.113.215.176:8080<br>27.64.209.67:4013<br>79.137.32.87:80<br>198.44.162.103:45787<br>60.173.24.141:9128<br>213.165.168.190:9898<br>223.215.176.149:8089<br>203.34.28.50:80<br>220.179.211.57:8089<br>220.179.210.244:8089<br>212.110.17.110:80<br>27.75.141.210:4005<br>185.74.6.247:8080<br>190.97.204.172:8080<br>8.242.190.116:999<br>203.150.128.198:8080<br>5.78.72.142:8080<br>49.71.119.177:8089<br>198.44.161.94:45787<br>43.251.117.224:45787<br>183.236.123.242:8060<br>49.89.84.198:8089<br>36.6.144.22:8089<br>45.234.61.7:999<br>24.172.34.114:49920<br>222.190.223.45:9128<br>120.202.128.112:9002<br>204.199.67.170:999<br>27.157.229.5:8089<br>49.88.168.249:8089<br>46.101.3.81:443<br>36.6.144.64:8089<br>59.59.158.136:8089<br>27.64.18.125:4013<br>36.6.145.134:8089<br>59.59.162.149:8089<br>49.89.103.253:8089<br>27.157.225.79:8089<br>49.88.158.152:8089<br>198.44.188.120:45787<br>27.157.229.232:8089<br>45.189.112.97:999<br>27.191.60.250:9128<br>27.157.230.143:8089<br>43.251.117.12:45787<br>65.108.69.40:10046<br>220.179.214.45:8089<br>3.219.158.209:80<br>210.245.35.35:8080<br>27.157.248.125:8089<br>193.3.52.6:8080<br>45.225.107.91:1994<br>27.150.161.225:8089<br>200.60.132.83:999<br>81.200.152.9:3128<br>27.64.31.129:4001<br>45.235.46.94:8080<br>36.137.156.54:7890<br>27.157.225.32:8089<br>27.68.82.51:4005<br>45.189.116.209:999<br>49.88.158.67:8089<br>223.215.176.251:8089<br>223.215.176.109:8089<br>223.215.177.253:8089<br>188.209.234.33:8080<br>183.165.251.212:8089<br>49.68.98.183:8089<br>59.59.128.105:8089<br>91.205.196.190:8080<br>221.1.84.189:9000<br>183.221.242.102:9443<br>27.157.230.243:8089<br>5.75.135.217:8080<br>213.171.63.210:41890<br>198.44.190.139:45787<br>52.79.107.158:8080<br>183.166.170.39:41122<br>46.35.86.253:8080<br>43.251.119.243:45787<br>43.251.118.70:45787<br>27.192.174.228:9000<br>49.68.100.8:8089<br>59.59.215.42:8089<br>27.76.128.55:4003<br>43.251.118.67:45787<br>207.154.250.139:3128<br>27.150.86.175:8089<br>172.86.112.242:3199<br>27.64.29.96:4013<br>59.59.158.82:8089<br>27.191.61.234:9128<br>27.191.61.255:9128<br>27.192.200.157:9000<br>200.24.204.247:999<br>49.70.33.122:8089<br>41.65.227.119:1981<br>27.76.131.141:4003<br>54.207.157.9:3128<br>164.68.123.119:9300<br>54.162.154.65:5000<br>50.16.45.86:3129<br>27.79.247.172:4001<br>198.44.191.68:45787<br>27.68.102.255:4009<br>222.78.209.100:8089<br>41.65.103.23:1976<br>49.70.85.231:8089<br>27.158.192.15:8089<br>171.239.240.228:4005<br>183.165.249.130:8089<br>27.157.229.164:8089<br>191.98.179.19:3128<br>202.179.86.6:8080<br>116.202.165.119:3124<br>36.137.157.23:7890<br>223.215.177.27:8089<br>198.44.189.101:45787<br>190.146.6.81:3128<br>159.223.22.33:443<br>89.41.106.8:4145<br>27.157.230.14:8089<br>39.108.55.102:8888<br>172.96.178.97:80<br>36.6.145.75:8089<br>59.59.158.89:8089<br>49.68.103.142:8089<br>86.74.138.221:8118<br>78.47.27.237:8080<br>197.232.39.208:65238<br>68.183.143.134:80<br>183.166.171.254:41122<br>87.246.54.221:8888<br>27.64.31.98:4017<br>183.164.243.217:8089<br>45.173.231.153:999<br>190.95.156.178:8080<br>27.64.210.135:4015<br>45.169.148.2:999<br>27.75.181.199:4005<br>123.182.58.252:8089<br>218.1.200.129:57114<br>46.161.247.27:8080<br>67.22.223.9:39593<br>222.190.208.43:8089<br>198.44.191.159:45787<br>89.189.81.240:8080<br>36.6.144.54:8089<br>27.79.229.94:4001<br>218.252.206.89:80<br>223.215.176.23:8089<br>49.86.180.136:8089<br>198.44.189.86:45787<br>45.130.99.42:8080<br>49.86.177.63:8089<br>203.150.128.57:8080<br>198.44.188.223:45787<br>197.32.1.131:8080<br>223.247.47.186:8089<br>27.75.136.251:4005<br>49.88.158.21:8089<br>59.60.211.140:8089<br>183.165.249.94:8089<br>45.233.170.109:999<br>27.76.130.61:4005<br>183.165.225.221:8089<br>222.190.173.40:8089<br>27.75.76.247:4009<br>45.236.241.160:8080<br>222.190.215.21:8089<br>61.132.170.203:8089<br>27.75.139.170:4015<br>27.79.204.115:4001<br>131.221.228.4:8080<br>43.250.175.46:38080<br>27.150.87.31:8089<br>27.157.229.135:8089<br>59.59.128.116:8089<br>49.70.89.209:8089<br>5.78.69.132:8080<br>27.205.47.81:9000<br>27.75.182.232:4015<br>94.181.33.149:40840<br>209.107.195.117:80<br>89.249.246.130:8080<br>45.229.33.158:999<br>61.154.89.129:8089<br>206.189.25.152:443<br>198.44.162.159:45787<br>27.191.62.177:9128<br>27.68.82.141:4005<br>49.88.158.236:8089<br>212.39.74.207:8080<br>202.134.23.39:8080<br>223.247.46.6:8089<br>36.6.158.123:8089<br>184.95.3.154:8888<br>186.159.6.163:1994<br>46.161.227.221:8080<br>41.222.62.41:9898<br>37.113.130.140:8080<br>59.59.212.250:8089<br>89.70.153.61:8118<br>59.59.163.29:8089<br>43.251.119.94:45787<br>27.157.228.240:8089<br>27.157.228.24:8089<br>223.215.177.219:8089<br>61.191.85.132:8089<br>27.157.225.90:8089<br>98.226.216.250:80<br>198.44.189.127:45787<br>36.134.91.82:8888<br>223.215.176.3:8089<br>198.44.191.177:45787<br>27.64.29.55:4013<br>41.220.1.33:32650<br>65.21.104.137:8080<br>36.6.145.114:8089<br>60.173.24.96:8089<br>49.86.181.212:8089<br>60.189.129.115:8085<br>203.19.38.114:1080<br>43.251.117.205:45787<br>198.44.188.170:45787<br>27.75.142.160:4015<br>49.88.157.27:8089<br>61.190.160.30:8089<br>198.44.188.57:45787<br>36.6.145.173:8089<br>27.64.28.30:4001<br>49.89.103.162:8089<br>27.158.125.76:8089<br>59.59.162.169:8089<br>85.133.144.94:8080<br>59.59.158.79:8089<br>27.130.74.227:8080<br>36.6.159.160:8089<br>49.0.246.130:45554<br>5.78.89.204:8080<br>5.75.230.128:8080<br>27.192.171.110:9000<br>94.23.76.57:3128<br>27.192.171.237:9000<br>27.191.60.156:9128<br>203.23.106.0:80<br>198.44.191.195:45787<br>49.68.97.70:8089<br>45.127.222.90:32650<br>115.77.146.177:4004<br>37.143.130.77:8888<br>201.91.201.52:3128<br>116.101.96.51:4013<br>59.59.163.241:8089<br>223.84.240.36:9091<br>49.68.102.184:8089<br>61.191.84.155:8089<br>49.68.99.148:8089<br>59.60.224.43:8089<br>20.210.113.32:8123<br>27.192.173.226:9000<br>43.251.118.174:45787<br>45.178.133.60:999<br>27.158.54.198:8089<br>5.160.243.238:8080<br>68.178.161.107:80<br>59.59.158.52:8089<br>183.166.148.59:41122<br>27.72.19.61:4003<br>206.62.171.84:999<br>45.174.172.201:999<br>46.101.19.131:80<br>27.214.50.94:9000<br>222.190.215.231:8089<br>49.86.178.168:8089<br>59.59.212.152:8089<br>220.179.211.100:8089<br>49.86.176.175:8089<br>27.157.223.49:8089<br>182.253.90.174:3125<br>49.86.182.86:8089<br>183.165.250.160:8089<br>222.190.208.191:8089<br>43.250.175.55:38080<br>36.6.140.238:8089<br>213.6.150.117:9999<br>206.189.151.138:80<br>43.251.118.203:45787<br>43.251.117.112:45787<br>222.190.173.82:8089<br>37.148.217.235:999<br>47.253.105.175:2080<br>45.144.30.72:3128<br>45.224.119.10:999<br>59.59.162.131:8089<br>38.88.23.190:80<br>27.157.230.244:8089<br>43.251.116.152:45787<br>221.239.179.146:8888<br>183.166.136.243:41122<br>27.73.248.212:4007<br>60.173.46.180:8089<br>222.190.208.198:8089<br>60.173.25.18:8089<br>34.87.88.180:80<br>31.31.186.162:8080<br>222.190.208.68:8089<br>43.251.119.11:45787<br>27.205.45.170:9000<br>59.59.158.58:8089<br>199.188.93.122:8000<br>203.150.128.248:8080<br>3.237.224.251:9999<br>202.40.188.92:40486<br>27.157.230.242:8089<br>27.205.44.215:9000<br>49.68.99.36:8089<br>66.42.53.102:80<br>27.150.92.65:8089<br>198.44.162.89:45787<br>116.63.128.247:9098<br>45.62.164.5:8080<br>190.108.82.108:999<br>45.189.255.17:999<br>60.173.24.9:9128<br>43.251.116.219:45787<br>175.178.159.150:2080<br>27.72.34.57:4003<br>27.76.237.39:4001<br>191.97.61.116:999<br>27.192.169.131:9000<br>27.76.253.189:4001<br>209.127.108.126:3000<br>27.76.86.238:4003<br>36.6.144.160:8089<br>27.158.8.197:8089<br>198.27.82.171:8888<br>31.31.191.82:8080<br>49.48.50.73:8080<br>43.251.117.55:45787<br>39.108.49.209:8888<br>60.173.24.179:8089<br>186.5.62.30:1994<br>27.64.28.42:4011<br>59.59.163.153:8089<br>187.109.37.53:20183<br>198.44.188.215:45787<br>49.86.183.179:8089<br>75.89.101.62:80<br>43.251.119.67:45787<br>36.6.159.159:8089<br>183.232.186.99:80<br>49.86.177.33:8089<br>27.157.225.42:8089<br>60.185.46.78:9128<br>27.74.57.33:4013<br>36.37.120.237:80<br>42.193.179.113:8118<br>45.8.106.97:80<br>59.66.20.172:4780<br>45.179.185.98:8083<br>185.200.36.174:8080<br>27.64.21.94:4007<br>202.180.19.41:8080<br>27.76.250.125:4001<br>222.190.223.217:8089<br>47.241.122.19:80<br>198.44.161.108:45787<br>200.19.179.114:443<br>223.215.176.81:8089<br>49.70.94.18:8089<br>27.157.3.31:8089<br>94.74.131.234:80<br>198.44.189.38:45787<br>5.78.65.191:8080<br>27.64.208.150:4001<br>183.164.242.198:8089<br>27.157.129.182:8089<br>27.68.107.210:4015<br>45.62.164.23:8080<br>27.157.230.28:8089<br>44.197.117.197:9999<br>124.158.154.18:3128<br>198.44.191.2:45787<br>27.64.31.69:4001<br>222.190.173.85:8089<br>222.190.173.11:8089<br>89.12.68.63:80<br>27.76.97.152:4001<br>8.218.125.194:59394<br>27.157.228.208:8089<br>223.247.47.249:8089<br>49.86.177.132:8089<br>95.189.123.70:8080<br>178.210.51.118:8080<br>223.215.177.163:8089<br>27.79.147.233:4013<br>49.68.98.32:8089<br>223.215.176.160:8089<br>60.173.47.134:8089<br>200.24.136.233:999<br>49.86.180.56:41122<br>95.211.4.70:80<br>27.158.127.32:8089<br>27.205.42.30:9000<br>118.140.172.77:8888<br>203.128.75.195:8080<br>43.251.119.8:45787<br>60.205.132.71:80<br>43.251.116.188:45787<br>3.91.55.217:9999<br>27.64.23.178:4013<br>91.107.233.110:8080<br>61.191.85.114:8089<br>223.247.47.69:8089<br>54.172.202.240:9999<br>60.173.47.12:8089<br>91.149.254.102:3128<br>49.68.99.230:8089<br>61.154.90.26:8089<br>27.157.229.4:8089<br>27.75.181.64:4005<br>27.192.200.224:9000<br>89.237.33.129:37647<br>27.150.35.100:8089<br>52.11.245.242:80<br>58.147.186.214:3125<br>220.179.210.245:8089<br>27.157.89.208:8089<br>93.171.225.190:80<br>203.30.190.118:80<br>222.190.223.108:8089<br>190.27.172.39:8080<br>27.150.86.69:8089<br>27.157.229.177:8089<br>5.78.80.62:8080<br>189.204.145.131:999<br>36.6.141.178:8089<br>59.60.0.77:7890<br>27.75.181.41:4007<br>64.226.66.47:8080<br>43.251.117.23:45787<br>27.157.230.148:8089<br>49.88.158.129:8089<br>27.65.145.70:4007<br>59.59.162.66:8089<br>43.251.117.210:45787<br>49.86.181.216:8089<br>27.72.19.18:4003<br>41.205.24.254:8080<br>182.253.28.124:8080<br>198.44.191.233:45787<br>36.6.144.197:8089<br>220.179.211.27:8089<br>27.96.130.95:3128<br>37.32.112.135:8080<br>197.210.143.182:36496<br>186.101.16.65:1994<br>31.220.183.217:53281<br>203.150.128.63:8080<br>43.251.119.146:45787<br>181.129.74.58:40667<br>27.64.31.242:4017<br>222.190.223.168:8089<br>192.163.215.98:80<br>59.60.211.97:8089<br>45.190.77.218:999<br>5.189.166.169:22<br>49.68.99.6:8089<br>27.76.128.71:4007<br>183.165.250.8:8089<br>38.95.179.120:80<br>88.198.196.34:8080<br>27.79.255.94:4001<br>5.78.82.248:8080<br>194.146.50.194:3128<br>43.251.118.241:45787<br>190.82.105.123:43949<br>37.187.20.166:3128<br>27.64.17.153:4015<br>103.124.136.14:80<br>223.215.176.182:8089<br>72.169.65.69:87<br>27.64.25.103:4013<br>190.186.18.161:999<br>27.64.29.200:4015<br>27.157.3.189:8089<br>27.75.188.250:4005<br>222.190.208.161:8089<br>198.44.190.229:45787<br>36.6.145.227:8089<br>203.150.128.170:8080<br>更好用的代理ip请访问：https://proxy.ip3366.net/")
	doc, err := htmlquery.Parse(bytes.NewReader(b))
	if err != nil {
		fmt.Println(err)
		return
	}
	for _, n := range htmlquery.Find(doc, "/html/body/br[position()>1]/following::text()") {
		fmt.Println(n.Data)
	}
}
